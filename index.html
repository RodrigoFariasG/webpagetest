<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de APIs - Boostr</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e1e2f;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #90caf9;
      margin-bottom: 30px;
    }
    .section {
      background-color: #2c2c3c;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .section h2 {
      color: #64b5f6;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .farmacia-card {
      background-color: #1a1a2a;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
      border-left: 3px solid #64b5f6;
    }
    .farmacia-card strong {
      color: #c3e88d;
      font-size: 1.1em;
    }
    select {
      background-color: #1a1a2a;
      color: #f0f0f0;
      border: 1px solid #555;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      width: 200px;
    }
    .loading {
      font-style: italic;
      color: #aaa;
      text-align: center;
      padding: 20px;
    }
    .error {
      color: #ff6b6b;
      background-color: #2d1b1b;
      padding: 10px;
      border-radius: 5px;
      border-left: 3px solid #ff6b6b;
    }
    .dato {
      margin-bottom: 8px;
      padding: 5px 0;
    }
    .dato strong {
      color: #90caf9;
    }
    .refresh-btn {
      background-color: #64b5f6;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    .refresh-btn:hover {
      background-color: #42a5f5;
    }
    .success {
      color: #4caf50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Dashboard de APIs Boostr</h1>

  <div class="section">
    <h2>📅 Santoral del Día</h2>
    <button class="refresh-btn" onclick="cargarSantoral()">🔄 Actualizar</button>
    <div id="santoral" class="loading">Cargando santoral...</div>
  </div>

  <div class="section">
    <h2>🌤️ Información Meteorológica</h2>
    <label for="clima-ciudad">Selecciona estación meteorológica:</label>
    <select id="clima-ciudad">
      <option value="SCIC">Curicó (SCIC)</option>
      <option value="SCFA">Santiago (SCFA)</option>
    </select>
    <button class="refresh-btn" onclick="cargarClimaActual()">🔄 Actualizar</button>
    <div id="clima" class="loading">Cargando información meteorológica...</div>
  </div>

  <div class="section">
    <h2>🏥 Farmacias 24 Horas</h2>
    <label for="farmacia-ciudad">Selecciona ciudad:</label>
    <select id="farmacia-ciudad">
      <option value="Curicó">Curicó</option>
      <option value="Santiago">Santiago</option>
      <option value="Talca">Talca</option>
      <option value="Rancagua">Rancagua</option>
      <option value="Temuco">Temuco</option>
      <option value="Concepción">Concepción</option>
      <option value="Valparaíso">Valparaíso</option>
    </select>
    <button class="refresh-btn" onclick="cargarFarmaciasActual()">🔄 Actualizar</button>
    <div id="farmacias" class="loading">Cargando farmacias...</div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuración de headers para las peticiones
    const options = {
      method: 'GET',
      headers: { 
        'accept': 'application/json',
        'User-Agent': 'Mozilla/5.0 (compatible; BootstrAPI/1.0)'
      },
      mode: 'cors', // Permitir CORS
      cache: 'no-cache' // Evitar cache
    };

    // Función para mostrar santoral
    function mostrarSantoral(data) {
      const cont = document.getElementById('santoral');
      console.log('Datos de santoral recibidos:', data);
      
      if (Array.isArray(data) && data.length > 0) {
        cont.innerHTML = '<div class="success">✅ Datos cargados correctamente</div>' + 
          data.map(item => 
            `<div class="dato"><strong>📅 ${item.fecha || 'Fecha no disponible'}</strong>: ${item.santoral || 'Sin información'}</div>`
          ).join('');
      } else if (data && data.santoral) {
        cont.innerHTML = '<div class="success">✅ Datos cargados correctamente</div>' +
          `<div class="dato"><strong>📅 ${data.fecha || 'Hoy'}</strong>: ${data.santoral}</div>`;
      } else if (data && typeof data === 'string') {
        cont.innerHTML = '<div class="success">✅ Datos cargados correctamente</div>' +
          `<div class="dato"><strong>📅 Santoral:</strong> ${data}</div>`;
      } else {
        cont.innerHTML = '<div class="error">❌ No se encontraron datos de santoral</div>';
      }
    }

    // Función para mostrar clima
    function mostrarClima(data) {
      const cont = document.getElementById('clima');
      console.log('Datos de clima recibidos:', data);
      
      if (data && typeof data === 'object') {
        let html = '<div class="success">✅ Datos meteorológicos cargados</div>';
        
        if (data.name) html += `<div class="dato"><strong>🏙️ Ubicación:</strong> ${data.name}</div>`;
        if (data.weather && data.weather[0]) {
          html += `<div class="dato"><strong>☁️ Condición:</strong> ${data.weather[0].description}</div>`;
          if (data.weather[0].main) html += `<div class="dato"><strong>🌡️ Estado:</strong> ${data.weather[0].main}</div>`;
        }
        if (data.main) {
          if (data.main.temp !== undefined) html += `<div class="dato"><strong>🌡️ Temperatura:</strong> ${data.main.temp}°C</div>`;
          if (data.main.feels_like !== undefined) html += `<div class="dato"><strong>🤔 Sensación térmica:</strong> ${data.main.feels_like}°C</div>`;
          if (data.main.humidity !== undefined) html += `<div class="dato"><strong>💧 Humedad:</strong> ${data.main.humidity}%</div>`;
          if (data.main.pressure !== undefined) html += `<div class="dato"><strong>📊 Presión:</strong> ${data.main.pressure} hPa</div>`;
        }
        if (data.wind) {
          if (data.wind.speed !== undefined) html += `<div class="dato"><strong>💨 Viento:</strong> ${data.wind.speed} m/s</div>`;
        }
        if (data.visibility !== undefined) html += `<div class="dato"><strong>👁️ Visibilidad:</strong> ${data.visibility} m</div>`;
        
        cont.innerHTML = html;
      } else {
        cont.innerHTML = '<div class="error">❌ No se pudieron cargar los datos meteorológicos</div>';
      }
    }

    // Función para mostrar farmacias
    function mostrarFarmacias(data, ciudad) {
      const contenedor = document.getElementById('farmacias');
      console.log('Datos de farmacias recibidos:', data);
      
      if (!Array.isArray(data)) {
        contenedor.innerHTML = '<div class="error">❌ Error en el formato de datos de farmacias</div>';
        return;
      }

      const filtradas = data.filter(f => 
        f.city && f.city.toLowerCase().includes(ciudad.toLowerCase()) ||
        f.commune && f.commune.toLowerCase().includes(ciudad.toLowerCase())
      );
      
      if (filtradas.length === 0) {
        contenedor.innerHTML = `<div class="error">❌ No se encontraron farmacias 24h en ${ciudad}</div>`;
        // Mostrar todas las farmacias disponibles como alternativa
        if (data.length > 0) {
          contenedor.innerHTML += '<div style="margin-top: 15px;"><strong>Farmacias disponibles en otras ciudades:</strong></div>';
          const ciudadesDisponibles = [...new Set(data.map(f => f.city || f.commune).filter(c => c))];
          contenedor.innerHTML += `<div class="dato">Ciudades con farmacias: ${ciudadesDisponibles.slice(0, 10).join(', ')}</div>`;
        }
        return;
      }

      contenedor.innerHTML = `<div class="success">✅ ${filtradas.length} farmacia(s) encontrada(s) en ${ciudad}</div>`;
      
      filtradas.forEach(f => {
        const card = document.createElement('div');
        card.className = 'farmacia-card';
        card.innerHTML = `
          <strong>🏥 ${f.name || 'Farmacia sin nombre'}</strong><br>
          <div class="dato">📍 <strong>Dirección:</strong> ${f.address || 'Dirección no disponible'}</div>
          <div class="dato">📞 <strong>Teléfono:</strong> ${f.phone || 'No disponible'}</div>
          <div class="dato">🏙️ <strong>Comuna:</strong> ${f.city || f.commune || 'No especificada'}</div>
          ${f.schedule ? `<div class="dato">🕐 <strong>Horario:</strong> ${f.schedule}</div>` : ''}
        `;
        contenedor.appendChild(card);
      });
    }

    // Función para mostrar errores con datos de respaldo
    function mostrarError(idElemento, nombre, err) {
      const elemento = document.getElementById(idElemento);
      console.error(`Error en ${nombre}:`, err);
      
      elemento.innerHTML = `<div class="error">❌ Error al cargar ${nombre}: ${err.message || err}</div>`;
      
      // Datos de respaldo (mock) en caso de error
      setTimeout(() => {
        if (idElemento === 'santoral') {
          elemento.innerHTML += '<div style="margin-top: 10px;"><strong>Datos de respaldo:</strong></div>';
          mostrarSantoral([{fecha: '03-06-2025', santoral: 'San Carlos Lwanga, San Clotilde'}]);
        }
        if (idElemento === 'clima') {
          elemento.innerHTML += '<div style="margin-top: 10px;"><strong>Datos de respaldo:</strong></div>';
          mostrarClima({
            name: 'Curicó',
            weather: [{description: 'Parcialmente nublado', main: 'Clouds'}],
            main: {temp: 15, feels_like: 13, humidity: 65, pressure: 1013},
            wind: {speed: 3.2},
            visibility: 10000
          });
        }
        if (idElemento === 'farmacias') {
          elemento.innerHTML += '<div style="margin-top: 10px;"><strong>Datos de respaldo:</strong></div>';
          const mockFarmacias = [
            {name: 'Farmacia Cruz Verde', address: 'Av. Libertador Bernardo O\'Higgins 123', phone: '+56-75-123-4567', city: 'Curicó'},
            {name: 'Salcobrand', address: 'Calle Estado 456', phone: '+56-75-987-6543', city: 'Curicó'}
          ];
          mostrarFarmacias(mockFarmacias, document.getElementById('farmacia-ciudad').value);
        }
      }, 1000);
    }

    // Cargar santoral
    function cargarSantoral() {
      document.getElementById('santoral').innerHTML = '<div class="loading">🔄 Cargando santoral...</div>';
      
      fetch('https://api.boostr.cl/santorales.json', options)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
        .then(mostrarSantoral)
        .catch(err => mostrarError('santoral', 'Santoral', err));
    }

    // Cargar clima
    function cargarClima(estacion) {
      document.getElementById('clima').innerHTML = '<div class="loading">🔄 Cargando datos meteorológicos...</div>';
      
      fetch(`https://api.boostr.cl/weather/${estacion}.json`, options)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
        .then(mostrarClima)
        .catch(err => mostrarError('clima', `Clima ${estacion}`, err));
    }

    // Cargar farmacias
    function cargarFarmaciasPorCiudad(ciudad) {
      document.getElementById('farmacias').innerHTML = '<div class="loading">🔄 Cargando farmacias...</div>';
      
      fetch('https://api.boostr.cl/pharmacies/24h.json', options)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          return res.json();
        })
        .then(data => mostrarFarmacias(data, ciudad))
        .catch(err => mostrarError('farmacias', 'Farmacias', err));
    }

    // Funciones globales para los botones de refresh
    window.cargarSantoral = cargarSantoral;
    window.cargarClimaActual = () => cargarClima(document.getElementById('clima-ciudad').value);
    window.cargarFarmaciasActual = () => cargarFarmaciasPorCiudad(document.getElementById('farmacia-ciudad').value);

    // Carga inicial de datos
    cargarSantoral();
    cargarClima('SCIC'); // Curicó por defecto
    cargarFarmaciasPorCiudad('Curicó');

    // Event listeners para los selectores
    document.getElementById('clima-ciudad').addEventListener('change', (e) => {
      cargarClima(e.target.value);
    });

    document.getElementById('farmacia-ciudad').addEventListener('change', (e) => {
      cargarFarmaciasPorCiudad(e.target.value);
    });

    // Actualización automática cada 5 minutos
    setInterval(() => {
      console.log('Actualizando datos automáticamente...');
      cargarSantoral();
      cargarClima(document.getElementById('clima-ciudad').value);
      cargarFarmaciasPorCiudad(document.getElementById('farmacia-ciudad').value);
    }, 300000); // 5 minutos
  });
  </script>
</body>
</html>